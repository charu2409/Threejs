<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rover Dashboard</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #hud {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      font-family: monospace;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<div id="hud">Waiting for data...</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

<script>
  let scene, camera, renderer, rover, hud;
  hud = document.getElementById("hud");

  // Setup scene
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 10, 20);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // Lighting
  const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
  hemiLight.position.set(0, 20, 0);
  scene.add(hemiLight);

  const dirLight = new THREE.DirectionalLight(0xffffff, 1);
  dirLight.position.set(-3, 10, -10);
  scene.add(dirLight);

  // Ground plane
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200, 200),
    new THREE.MeshPhongMaterial({ color: 0x333333 })
  );
  ground.rotation.x = -Math.PI/2;
  scene.add(ground);

  // Load rover model (replace with real rover .glb later)
  const loader = new THREE.GLTFLoader();
  loader.load("https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf",
    function(gltf) {
      rover = gltf.scene;
      rover.scale.set(2,2,2);
      rover.position.set(0, 0, 0);
      scene.add(rover);
    }
  );

  // Controls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);

  // Coordinate origin (reference point)
  const baseLat = 12.2958;
  const baseLon = 76.6394;

  function latLonToXZ(lat, lon) {
    const scale = 100000; // adjust scaling factor
    const x = (lon - baseLon) * scale;
    const z = (lat - baseLat) * scale;
    return { x, z };
  }

  // Fetch live rover data
  async function getRoverData() {
    try {
      const res = await fetch("http://localhost:5000/rover");
      const data = await res.json();

      hud.innerText = 
        `Lat: ${data.lat.toFixed(6)}\n` +
        `Lon: ${data.lon.toFixed(6)}\n` +
        `Yaw: ${data.yaw.toFixed(1)}Â°\n` +
        `Speed: ${data.speed.toFixed(2)} m/s`;

      if (rover) {
        const pos = latLonToXZ(data.lat, data.lon);
        rover.position.set(pos.x, 0, pos.z);
        rover.rotation.y = THREE.MathUtils.degToRad(data.yaw);
      }
    } catch (e) { console.error("API error", e); }
  }

  setInterval(getRoverData, 1000); // poll every 1 sec

  // Animate
  function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
